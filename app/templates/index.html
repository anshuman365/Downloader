{% extends "base.html" %}
{% block title %}YouTube AutoDownloader{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
<style>
    .hero {
        background: linear-gradient(135deg, var(--primary), #1a73e8);
        color: white;
        padding: 60px 0;
        text-align: center;
        border-radius: var(--radius);
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
    }
    
    .hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23000000' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.1;
    }
    
    .hero-content {
        position: relative;
        z-index: 1;
        max-width: 700px;
        margin: 0 auto;
    }
    
    .hero h1 {
        color: white;
        font-size: 2.5rem;
        margin-bottom: 20px;
    }
    
    .hero p {
        font-size: 1.2rem;
        margin-bottom: 30px;
        opacity: 0.9;
    }
    
    .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin: 40px 0;
    }
    
    .feature-card {
        background-color: var(--card-bg);
        border-radius: var(--radius);
        padding: 25px;
        text-align: center;
        transition: var(--transition);
        border: 1px solid var(--border);
    }
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }
    
    .feature-icon {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 15px;
    }
    
    .feature-card h3 {
        margin-bottom: 15px;
        color: var(--text);
    }
    
    .feature-card p {
        color: var(--text-light);
    }
    
    .stats {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        min-width: 120px;
        text-align: center;
    }
    
    .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .user-greeting {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .user-greeting img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    
    .nav-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .nav-card {
        background-color: var(--card-bg);
        border-radius: var(--radius);
        padding: 25px;
        text-align: center;
        transition: var(--transition);
        border: 1px solid var(--border);
    }
    
    .nav-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }
    
    .nav-card i {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 15px;
    }
    
    .nav-card h3 {
        margin-bottom: 15px;
    }
    
    .nav-card p {
        margin-bottom: 20px;
        color: var(--text-light);
    }
    
    .security-info {
        text-align: center;
        padding: 15px;
        background-color: rgba(76, 175, 80, 0.1);
        border-radius: var(--radius);
        margin: 20px 0;
    }
    
    .security-info i {
        color: #4CAF50;
        margin-right: 10px;
    }
    
    .card {
        background-color: var(--card-bg);
        border-radius: var(--radius);
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .search-container {
        margin-bottom: 20px;
        position: relative;
    }
    
    .search-results {
        margin-top: 10px;
        background-color: var(--card-bg);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        max-height: 300px;
        overflow-y: auto;
        position: absolute;
        width: 100%;
        z-index: 100;
        box-shadow: var(--shadow-md);
    }

    .search-item {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .search-item:hover {
        background-color: var(--card-bg-hover);
    }

    .search-item img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        margin-right: 10px;
        border-radius: 4px;
    }

    .search-item-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .search-item-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-item-duration {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .search-status {
        padding: 10px;
        text-align: center;
        color: var(--text-light);
        font-style: italic;
    }

    .search-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
    }

    .spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .input-box {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 100%;
        height: 40px;
        font-size: 16px;
    }

</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update quality options based on media type
        const mediaTypeSelect = document.getElementById('media-type-select');
        const qualitySelect = document.getElementById('quality-select');
        
        const audioQualities = {{ config.AUDIO_QUALITIES|list|tojson }};
        const videoQualities = {{ config.VIDEO_QUALITIES|list|tojson }};
        
        function updateQualityOptions() {
            const isAudio = mediaTypeSelect.value === 'audio';
            const qualities = isAudio ? audioQualities : videoQualities;
            
            // Clear existing options
            qualitySelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Default';
            qualitySelect.appendChild(defaultOption);
            
            // Add quality options
            qualities.forEach(quality => {
                const option = document.createElement('option');
                option.value = quality;
                option.textContent = quality;
                qualitySelect.appendChild(option);
            });
        }
        
        // Initial update
        updateQualityOptions();
        
        // Update when media type changes
        mediaTypeSelect.addEventListener('change', updateQualityOptions);
        
        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let searchController = null;
        
        function clearSearchResults() {
            searchResults.innerHTML = '';
        }
        
        function showSearchLoading() {
            searchResults.innerHTML = `
                <div class="search-loading">
                    <div class="spinner"></div>
                    <span>Searching...</span>
                </div>
            `;
            searchResults.style.display = 'block';
        }
        
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Cancel previous request if still pending
            if (searchController) {
                searchController.abort();
            }
            
            if (query.length < 3) {
                clearSearchResults();
                return;
            }
            
            showSearchLoading();
            
            // Create new AbortController for current request
            searchController = new AbortController();
            const signal = searchController.signal;
            
            fetch(`/main/api/search?q=${encodeURIComponent(query)}`, { signal })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length === 0) {
                        searchResults.innerHTML = '<div class="search-status">No results found</div>';
                        return;
                    }
                    
                    clearSearchResults();
                    data.forEach(item => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-item';
                        resultItem.innerHTML = `
                            <img src="${item.thumbnail}" alt="${item.title}">
                            <div class="search-item-info">
                                <div class="search-item-title">${item.title}</div>
                                <div class="search-item-duration">${item.duration}</div>
                            </div>
                        `;
                        resultItem.addEventListener('click', function() {
                            searchInput.value = item.url;
                            clearSearchResults();
                        });
                        searchResults.appendChild(resultItem);
                    });
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        // Request was canceled, ignore
                        return;
                    }
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="search-status">Search failed. Please try again.</div>';
                })
                .finally(() => {
                    searchController = null;
                });
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!searchResults.contains(event.target) && event.target !== searchInput) {
                clearSearchResults();
            }
        });
        
        // Prevent closing when clicking inside search results
        searchResults.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="hero">
    <div class="hero-content">
        <h1>YouTube AutoDownloader</h1>
        <p>Download YouTube videos and audio quickly and securely</p>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-cloud-download-alt"></i></div>
                <div class="stat-value">{{ history_count }}</div>
                <div class="stat-label">Downloads Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value">{{ user_count }}</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-hdd"></i></div>
                <div class="stat-value">{{ storage_used }}</div>
                <div class="stat-label">Storage Used</div>
            </div>
        </div>
    </div>
</div>

<div class="page-header">
    <h1>Download Content</h1>
    {% if username %}
    <div class="user-greeting">
        <img src="https://ui-avatars.com/api/?name={{ username }}&background=random" alt="User">
        <span>Welcome, {{ username }}!</span>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2>Add New Download</h2>
    </div>
    <form method="POST" action="{{ url_for('main.add_task') }}">
        <div class="form-grid">
            <input type="text" name="input" placeholder="YouTube URL or search term" class="input-box" required>
            <select name="media_type" id="media-type-select">
                <option value="audio" {% if user and user.default_audio_quality %}selected{% endif %}>MP3 (Audio)</option>
                <option value="video" {% if user and user.default_video_quality %}selected{% endif %}>MP4 (Video)</option>
            </select>
            <select name="quality" id="quality-select">
                <!-- Options populated by JavaScript -->
            </select>
        </div>
        <button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Add to Download Queue</button>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <h2>Search YouTube</h2>
    </div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Type to search videos..." class="full-width input-box">
        <div id="search-results" class="search-results">
            <!-- Results populated by JavaScript -->
        </div>
    </div>
</div>

<div class="nav-cards">
    <div class="nav-card">
        <i class="fas fa-list"></i>
        <h3>Download Queue</h3>
        <p>View and manage your current downloads</p>
        <a href="{{ url_for('main.queue') }}" class="btn">View Queue</a>
    </div>
    <div class="nav-card">
        <i class="fas fa-history"></i>
        <h3>Download History</h3>
        <p>Access your previously downloaded content</p>
        <a href="{{ url_for('main.history') }}" class="btn">View History</a>
    </div>
    <div class="nav-card">
        <i class="fas fa-cog"></i>
        <h3>Settings</h3>
        <p>Configure your download preferences</p>
        <a href="{{ url_for('user.settings') }}" class="btn">Account Settings</a>
    </div>
</div>

<div class="security-info">
    <p><i class="fas fa-shield-alt"></i> Your downloads are private and secure. We never store your personal data.</p>
</div>

<div class="features">
    <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-bolt"></i></div>
        <h3>Fast Downloads</h3>
        <p>High-speed downloads with our optimized servers</p>
    </div>
    <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-lock"></i></div>
        <h3>Secure & Private</h3>
        <p>End-to-end encryption for your downloads</p>
    </div>
    <div class="feature-card">
        <div class="feature-icon"><i class="fas fa-infinity"></i></div>
        <h3>Unlimited Access</h3>
        <p>No restrictions on video length or quality</p>
    </div>
</div>
{% endblock %}